
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.7">
    
    
      
        <title>基于机器学习的恶意URL检测 - AI for Security</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cd566b2a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#url" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="AI for Security" class="md-header__button md-logo" aria-label="AI for Security" data-md-component="logo">
      
  <img src="../assets/logo_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AI for Security
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              基于机器学习的恶意URL检测
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AI for Security" class="md-nav__button md-logo" aria-label="AI for Security" data-md-component="logo">
      
  <img src="../assets/logo_white.png" alt="logo">

    </a>
    AI for Security
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Index
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0x0_%E7%9B%B8%E5%85%B3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="md-nav__link">
        相关基础知识
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0x1_%E5%9F%BA%E4%BA%8Ekmeans%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B/" class="md-nav__link">
        基于k-means的网络异常通讯检测
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0x2_%E5%9F%BA%E4%BA%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%9A%84DGA%E6%A3%80%E6%B5%8B/" class="md-nav__link">
        基于深度学习的DGA检测
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          基于机器学习的恶意URL检测
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        基于机器学习的恶意URL检测
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    概述
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    提出问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    数据处理
  </a>
  
    <nav class="md-nav" aria-label="数据处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    样本选择
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    数据清洗
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    特征提取
  </a>
  
    <nav class="md-nav" aria-label="特征提取">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tf-idf" class="md-nav__link">
    注：TF-IDF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    模型选择
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    效果评估
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    完整代码
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    概念补充
  </a>
  
    <nav class="md-nav" aria-label="概念补充">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    逻辑回归
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#svm" class="md-nav__link">
    支持向量机（SVM）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    概述
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    提出问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    数据处理
  </a>
  
    <nav class="md-nav" aria-label="数据处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    样本选择
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    数据清洗
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    特征提取
  </a>
  
    <nav class="md-nav" aria-label="特征提取">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tf-idf" class="md-nav__link">
    注：TF-IDF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    模型选择
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    效果评估
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    完整代码
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    概念补充
  </a>
  
    <nav class="md-nav" aria-label="概念补充">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    逻辑回归
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#svm" class="md-nav__link">
    支持向量机（SVM）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="url">基于机器学习的恶意URL检测</h1>
<h2 id="_1">目录</h2>
<div class="toc">
<ul>
<li><a href="#url">基于机器学习的恶意URL检测</a><ul>
<li><a href="#_1">目录</a></li>
<li><a href="#_2">概述</a></li>
<li><a href="#_3">提出问题</a></li>
<li><a href="#_4">数据处理</a><ul>
<li><a href="#_5">样本选择</a></li>
<li><a href="#_6">数据清洗</a></li>
</ul>
</li>
<li><a href="#_7">特征提取</a><ul>
<li><a href="#tf-idf">注：TF-IDF</a></li>
</ul>
</li>
<li><a href="#_8">模型选择</a></li>
<li><a href="#_9">效果评估</a></li>
<li><a href="#_10">完整代码</a></li>
<li><a href="#_11">概念补充</a><ul>
<li><a href="#_12">逻辑回归</a></li>
<li><a href="#svm">支持向量机（SVM）</a></li>
</ul>
</li>
<li><a href="#reference">Reference</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="_2">概述</h2>
<p>本次实践虽题为”基于机器学习“，但目前也只更新到使用TF-IDF和线性回归模型的进度。不过千里之行始于足下嘛，后面再更啦🐦</p>
<h2 id="_3">提出问题</h2>
<p>首先我们需要将安全问题进行抽象，也就是针对现状提出问题。在假定的这个业务背景下，我们发现：</p>
<ul>
<li>
<p>恶意URL存在特定几种类型1</p>
</li>
<li>
<p>特定类型恶意URL在文本上存在普遍的<strong>词汇特征</strong>，例如钓鱼URL中常见"login", "account", "sigin"等关键词</p>
</li>
</ul>
<p>因此我们尝试使用机器学习算法对恶意URL进行检测分析。</p>
<h2 id="_4">数据处理</h2>
<h3 id="_5">样本选择</h3>
<ul>
<li><a href="https://github.com/faizann24/Using-machine-learning-to-detect-malicious-URLs">malicious-URLs</a><ul>
<li><strong>malicious-URLs</strong> 在Github上面一个 使用机器学习去检测恶意URL的项目 ，里面有一个训练集，有做标记是正常的URL还是恶意的URL</li>
<li>内容类型：文本样本</li>
<li>是否标记：是</li>
<li>是否特征化：否</li>
<li>使用范围：入侵检测、异常流量、WAF</li>
</ul>
</li>
</ul>
<h3 id="_6">数据清洗</h3>
<p>由于样本本身为处理好的标记数据，所以在数据格式和脏数据上无需处理（真实情况下可能正好相反:-(）。</p>
<p>编写数据帧提取函数：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">csv_data_read</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">):</span>
    <span class="c1"># 为减少训练时间，可只取头部10W条，但一定需要先打乱样本）</span>
    <span class="c1"># df_csv = pd.read_csv(csv_file_path).head(100000)</span>
    <span class="n">df_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_csv</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">urls</span><span class="p">,</span> <span class="n">labels</span>
</code></pre></div>
<p>编写对URL的数据清洗函数：
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">url_tokenize</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    对URL进行清洗，删除斜线、点、和com，进行分词</span>
<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">web_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">dot_slash</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">web_url</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">slash</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">token_slash</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">)):</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">token_slash</span> <span class="o">=</span> <span class="n">token_slash</span> <span class="o">+</span> <span class="n">r2</span>
        <span class="n">dot_slash</span> <span class="o">=</span> <span class="n">dot_slash</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">token_slash</span>
    <span class="n">urltoken_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dot_slash</span><span class="p">))</span>
    <span class="n">white_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;http:&quot;</span><span class="p">,</span> <span class="s2">&quot;https:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">white_word</span> <span class="ow">in</span> <span class="n">white_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">white_word</span> <span class="ow">in</span> <span class="n">urltoken_list</span><span class="p">:</span>
            <span class="n">urltoken_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">white_word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urltoken_list</span>
</code></pre></div></p>
<h2 id="_7">特征提取</h2>
<p>我们首先加载数据集：</p>
<div class="highlight"><pre><span></span><code>    <span class="n">grep_csv_file_path</span> <span class="o">=</span> <span class="s2">&quot;../../data/data-0x3/grey-url.csv&quot;</span>
    <span class="n">black_csv_file_path</span> <span class="o">=</span> <span class="s2">&quot;../../data/data-0x3/black-url.csv&quot;</span>
    <span class="n">grey_urls</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">csv_data_read</span><span class="p">(</span><span class="n">grep_csv_file_path</span><span class="p">)</span>
</code></pre></div>
<p>我们使用TF-IDF算法提取URL的特征，并将数据帧划分为训练集和测试集：</p>
<div class="highlight"><pre><span></span><code>    <span class="n">url_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">url_tokenize</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">url_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">grey_urls</span><span class="p">)</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<h3 id="tf-idf">注：TF-IDF</h3>
<p>TF-IDF(Term Frequency – Inverse Document Frequency)，即词频-逆文档频率。在计算上为词频和逆文档频率的乘积。计算方法如下：</p>
<ul>
<li>计算词频（TF）<ul>
<li>某个词在文章中出现的次数/文章的总词数</li>
<li>即某个词在这段文字中出现得越多，TF就越大</li>
</ul>
</li>
<li>计算逆文档频率（IDF）<ul>
<li>log(语料库的文档总数/包含该词的文档数+1)</li>
<li>某个词在普遍情况下越常见，分母大，IDF也约趋于0</li>
</ul>
</li>
<li>计算TF-IDF<ul>
<li>TF-IDF = TF * IDF</li>
<li>TF-IDF越大，说明词在这段文章中越重要，但因为有IDF的存在，又能避免把“是”、”的“、“和”等停用词的TF-IDF值降低</li>
</ul>
</li>
</ul>
<p>在应用上：将文章分词，计算TF-IDF，按照其值大小降序排列，排名靠前的即文章的关键词</p>
<h2 id="_8">模型选择</h2>
<p>接下来，我们对数据集使用<strong>逻辑回归模型</strong>，并将将拟合后的模型和向量保存为本地文件，便于重复使用</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># 对训练集和测试集执行逻辑回归</span>
    <span class="n">l_regress</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
    <span class="n">l_regress</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">l_score</span> <span class="o">=</span> <span class="n">l_regress</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="c1"># print(&quot;测试拟合分数为：{0}&quot;.format(l_score))</span>

    <span class="n">file_mode</span> <span class="o">=</span> <span class="s2">&quot;../../model/model-0x3/model.pkl&quot;</span>
    <span class="n">dump_model_object</span><span class="p">(</span><span class="n">file_mode</span><span class="p">)</span>
    <span class="n">file_vector</span> <span class="o">=</span> <span class="s2">&quot;../../model/model-0x3/vector.pl&quot;</span>
    <span class="n">dump_model_object</span><span class="p">(</span><span class="n">file_vector</span><span class="p">)</span>
</code></pre></div>
<p>此外，我们也可以使用支持向量机模型：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">practice_svm</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    实践SVM算法识别恶意URL</span>
<span class="sd">    :param x_train:</span>
<span class="sd">    :param x_test:</span>
<span class="sd">    :param y_train:</span>
<span class="sd">    :param y_test:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_svm</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">()</span>
    <span class="c1"># 注意：SVM训练可能较慢，注意样本的数量</span>
    <span class="n">model_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">svm_score</span> <span class="o">=</span> <span class="n">model_svm</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;测试拟合分数为：</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">svm_score</span><span class="p">))</span>
    <span class="n">model_svm_save</span> <span class="o">=</span> <span class="n">model_svm</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    保存训练好的模型和向量</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_mode</span> <span class="o">=</span> <span class="s2">&quot;../../model/model-0x3/model_svm.pkl&quot;</span>
    <span class="n">dump_model_object</span><span class="p">(</span><span class="n">file_mode</span><span class="p">,</span> <span class="n">model_svm_save</span><span class="p">)</span>
</code></pre></div>
<h2 id="_9">效果评估</h2>
<p>在“特征提取”部分我们采用<code>train_test_split</code>方法进行随机划分训练集和测试集，进行<strong>交叉验证</strong>，再次回顾代码为：</p>
<div class="highlight"><pre><span></span><code><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p>使用线性回归模型，最后得到测试拟合分数为：<strong>0.9599966703530615</strong></p>
<p>注，参数介绍：</p>
<ul>
<li><code>test_size</code>：测试集在总样本中的占比</li>
<li><code>random_state</code>：随机数的种子，也可以理解为该组随机数的编号。规则是：种子不同时，产生不同的随机数；种子相同时，在不同实例下也产生相同的随机数。比如在上面的语句中，<code>test_size</code>为0.2，即选择总样本的20%作为测试集，但是如何选择呢？<code>random_state</code>就指定了：按照“第42种”规则选择这20%随机的数据。</li>
</ul>
<p>使用支持向量机模型时，发现在数据量较大的情况下，该模型的运算速度较慢，因此在实验环境下不得已减少了训练样本的数量，但也导致了拟合分数的降低，所以就不展示在样本缩水情况下的测试拟合分数了。同时，也了解到这是传统二分类SVM在面对大数据量时的弊端，并且随着集成学习的成熟，SVM现在“普遍用于集成学习中基模型的构建”[2]，而不是作为唯一的分类模型使用。</p>
<h2 id="_10">完整代码</h2>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Author: Toky</span>
<span class="sd">Description: 基于机器学习的恶意URL检测</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>


<span class="k">def</span> <span class="nf">csv_data_read</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">):</span>
    <span class="c1"># 为减少训练时间，可只取头部10W条，但一定需要先打乱样本）</span>
    <span class="c1"># df_csv = pd.read_csv(csv_file_path).head(100000)</span>
    <span class="n">df_csv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_csv</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">urls</span><span class="p">,</span> <span class="n">labels</span>


<span class="k">def</span> <span class="nf">url_tokenize</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    对URL进行清洗，删除斜线、点、和com，进行分词</span>
<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">web_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">dot_slash</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">web_url</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">slash</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">token_slash</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">)):</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">token_slash</span> <span class="o">=</span> <span class="n">token_slash</span> <span class="o">+</span> <span class="n">r2</span>
        <span class="n">dot_slash</span> <span class="o">=</span> <span class="n">dot_slash</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">token_slash</span>
    <span class="n">urltoken_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dot_slash</span><span class="p">))</span>
    <span class="n">white_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;http:&quot;</span><span class="p">,</span> <span class="s2">&quot;https:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">white_word</span> <span class="ow">in</span> <span class="n">white_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">white_word</span> <span class="ow">in</span> <span class="n">urltoken_list</span><span class="p">:</span>
            <span class="n">urltoken_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">white_word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urltoken_list</span>


<span class="k">def</span> <span class="nf">dump_model_object</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">model_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    使用pickle将内存中的对象转换为文本流保存为本地文件</span>
<span class="sd">    :param file_path:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    加载数据集</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grep_csv_file_path</span> <span class="o">=</span> <span class="s2">&quot;../../data/data-0x3/grey-url.csv&quot;</span>
    <span class="n">black_csv_file_path</span> <span class="o">=</span> <span class="s2">&quot;../../data/data-0x3/black-url.csv&quot;</span>
    <span class="n">grey_urls</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">csv_data_read</span><span class="p">(</span><span class="n">grep_csv_file_path</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    使用TF-IDF算法提取关键词特征，并将数据帧划分为训练集和测试集</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">url_tokenize</span><span class="p">)</span>
    <span class="n">url_vectorizer_save</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">url_vectorizer</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">url_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">grey_urls</span><span class="p">)</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    对数据帧执行逻辑回归，将拟合后的模型和向量保存</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 对训练集和测试集执行逻辑回归</span>
    <span class="n">l_regress</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
    <span class="n">l_regress</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">l_score</span> <span class="o">=</span> <span class="n">l_regress</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;测试拟合分数为：</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_score</span><span class="p">))</span>

    <span class="n">file_mode</span> <span class="o">=</span> <span class="s2">&quot;../../model/model-0x3/model.pkl&quot;</span>
    <span class="n">dump_model_object</span><span class="p">(</span><span class="n">file_mode</span><span class="p">,</span> <span class="n">l_regress</span><span class="p">)</span>
    <span class="n">file_vector</span> <span class="o">=</span> <span class="s2">&quot;../../model/model-0x3/vector.pl&quot;</span>
    <span class="n">dump_model_object</span><span class="p">(</span><span class="n">file_vector</span><span class="p">,</span> <span class="n">url_vectorizer_save</span><span class="p">)</span>
</code></pre></div>
<h2 id="_11">概念补充</h2>
<h3 id="_12">逻辑回归</h3>
<p>逻辑回归模型通过逻辑函数对数据进行<strong>分类</strong>，通常包括用于估计逻辑模型结果的独立二元变量。相比于线性回归，逻辑回归处理的分类问题，输出的结果为离散值；而线性回归解决的是回归问题输出的是连续值。</p>
<p>详细解读可以参考文章[1]，注意，虽然该算法在用起来时显得非常简单，但是其原理中的细节部分还是很多的，感兴趣可以仔细研究一下。</p>
<h3 id="svm">支持向量机（SVM）</h3>
<p>支持向量机（Surport Vector Machine, SVM）同样用于分类，是一个二元分类算法，但修改后也支持多分类问题。支持向量机通过在高维空间中创建最佳超平面来实现，这个超平面创建的划分被称为类。</p>
<p>对于分类问题本质的理解，就是我们需要找到一个划分的超平面，让数据尽可能多地分布在这个平面的两侧，从而实现分类的效果。但在实际数据下，往往存在多个超平面，那么此时我们怎么取舍呢？就是比较容易分类错误的数据点，而这些点就是离平面很近的点，因为离平面很远的点是相差很大的，基本不会存在分类错误的情况。而SVM的核心思想就是如此，找到离平面很近的、容易分类错误的点，然后想办法让这些数据点离平面距离变远。那些离超平面很近的点也就被称为支持向量（Support Vector）。</p>
<p>详细的数学原理，可以参考文章[2]，该算法有比较完备的数学理论支撑的，但详细的数理和推倒也相对比较复杂，因此也可以看自己需要进行学习（~~其实就是我看不懂，不献丑来推导了~~）。</p>
<h2 id="reference">Reference</h2>
<p>[1]【机器学习】逻辑回归（非常详细），<a href="https://www.zhihu.com/people/is-aze">阿泽</a>，https://zhuanlan.zhihu.com/p/74874291</p>
<p>[2] 05 SVM - 支持向量机 - 概念、线性可分，<a href="https://www.jianshu.com/u/a9f6de37f77b">白尔摩斯</a>，https://www.jianshu.com/p/410a56129757</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../0x2_%E5%9F%BA%E4%BA%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%9A%84DGA%E6%A3%80%E6%B5%8B/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 基于深度学习的DGA检测" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              基于深度学习的DGA检测
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.01de222e.min.js"></script>
      
    
  </body>
</html>